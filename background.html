<html>
  <script>
    /** ID of designated search window */
    var myWindow = 0;
    var query = "";
    var search = false;
    var page;

    /* deal with requests from the popup */
    chrome.extension.onRequest.addListener(function(request, sender, sendResponse) {
      /* recieve new search query from popup */
      if(request.rType=="init")
      {
        search = true;
        query = request.greeting;
        /* create a designated window for this search */
        chrome.windows.create({"url":"http://google.com/search?q="+request.greeting},function(wind){   
        
          myWindow = wind.id; /* get the ID of created search window */
          var notification = webkitNotifications.createNotification(
            'icon.png',  // icon url 
            'New Search...',  // title
            "Beginning search for '"+request.greeting+"'");
        
          notification.show();
          setTimeout(function(){
            notification.cancel();
            }, '3200');           
        
          go(request.greeting);       
        });
      } else if(request.rType=="query") {
        if(search){  /* send search term to popup for display*/
          sendResponse({q:query});
        }else{
          sendResponse({q:""});
        }
      } else if(request.rType=="finish") {
        finish(); /* mark search as over */
      } else if(request.rType=="cancel") {
        //TODO: cancel search
      }

    });
    /** the last time a tab was selected or updated */
    var oldTime = new Date().getTime();
    var time;
    /** list of domains visited */
    var domains = {};
    /** total active time for each tab's current page */
    var tabTimes = [];
    /** store the latest page opened in each tab */
    var tabURLs = [];

    function go(query)
    {
      var activeTab;
      chrome.tabs.getSelected(null,function(tab)
      {
          activeTab = tab.id;
      });        
      tabTimes[activeTab] = 1;
      inject(query);

      /* keep track of the selected tab */
      chrome.tabs.onSelectionChanged.addListener(function(tabId,selectInfo)
      {
        /* ensure this tab is in our specified search window... */
        if(selectInfo.windowId != myWindow)
        {
          return;
        }

        if(tabTimes[activeTab])
        { 
          /* add the time this tab's page was active for... */
          tabTimes[activeTab] = tabTimes[activeTab] + (new Date().getTime()-oldTime);
        }
        else
        {
          tabTimes[activeTab] = new Date().getTime()-oldTime;
        }
         inject(query);
          var notification = webkitNotifications.createNotification(
          'icon.png',  // icon url - can be relative
          'Tab change',  // notification title
          "Spent "+Math.round((new Date().getTime()-oldTime)/1000)+"s in previous tab...\
          previous tab active total: "+Math.round(tabTimes[activeTab]/1000)+"s");
          activeTab = tabId; /* mark this tab as the active one now */
          oldTime = new Date().getTime(); /* save time of change */
        
          notification.show();
          setTimeout(function(){
          notification.cancel();
          }, '2000');
      });

      chrome.tabs.onRemoved.addListener(function(tabId, removeInfo) 
      {
        if(!tabTimes[tabId])
        {
          return; /* page isn't in our window, ignore */
        }
        var spent = new Date().getTime()-oldTime; /* end page's visit timer */
        updateTime(tabURLs[tabId],tabTimes[tabId]+spent); /* update JSON object */

        var notification = webkitNotifications.createNotification(
          'icon.png', 'Tab closed',  
          "you've left: "+tabURLs[tabId]+", \n\r you've spent about "+
          Math.round((domains[getDomain(tabURLs[tabId])].pages[tabURLs[tabId]].time+spent)/1000)+" seconds on this page in \
          your '"+query+"'' search session"
          );
          // Then show the notification.
          notification.show();
          setTimeout(function(){
          notification.cancel();
          }, '6000');

       
      });

      /* React when a page is visited */
      chrome.tabs.onUpdated.addListener(function(tabId,changeInfo,tab)
      {
        /* ensure this occurs within designated search window*/
        if(tab.windowId != myWindow)
        {
          return;
        }
        if(changeInfo.url) /* wait till the url is ready */
        {
          var dom = getDomain(changeInfo.url);
          if(dom=="newtab")
          {
            return;
          }
          inject(query);
          
          var spent = new Date().getTime()-oldTime; /* end previous page's visit timer */
          if(tabURLs[activeTab])
          {
            updateTime(tabURLs[activeTab],tabTimes[activeTab]+spent);
          }
          tabURLs[tabId] = changeInfo.url; 
          tabTimes[tabId] = 1; /* reset active time counter */

          
          oldTime = new Date().getTime(); /* mark start of this page's visitation */

          
          var domainMessage;
          if (domains[dom])
          {
            domainMessage = "not a new domain";        
          }
          else
          {
            domains[dom] = newDomain(dom,changeInfo.url,tabId,time);
            domainMessage = "moved to new domain!";
          }
          if(!domains[dom].pages[changeInfo.url])
          {
            domains[dom].pages[changeInfo.url]=newPage(changeInfo.url,tabId,0);
          }

          var notification = webkitNotifications.createNotification(
          'icon.png', 'Page changed!',
          "you moved to page: "+changeInfo.url+", \n\r you spent about "+Math.round(spent/1000)+" seconds on previous page.\
          \n\r domain: \""+dom+"\"\
          \n\r "+ domainMessage // notification body text
          );
          // Then show the notification.
          notification.show();
          setTimeout(function(){
          notification.cancel();
          }, '6000');
        }
      });
    }
    /* end of search */
    chrome.windows.onRemoved.addListener(function( windowId) {
      if(windowId == myWindow)
      {
        finish();
      }
    });

    function getDomain(url)
    {
      return url.match(/:\/\/(.[^/]+)/)[1];
    }

    /* create JSON object for a domain */
    function newDomain(domain, url, tabId,startTime)
    {
      var thisPage = newPage(url, tabId, startTime);
      var dom = {
                "name": domain,
                "start": 0,
                "payment":false,
                "downloads":0, 
                "visited":1,    /* # of pages visited in this domain */
                "pages": {}, /* list of pages visited in this domain */                
              };
              dom.pages[url]=thisPage;
              //alert(dom.pages["url"].url);
              return dom;

    }

    /* create JSON object for a specific page */
    function newPage(url, tabId, startTime)
    {
      return {
                    "url": url ,
                    "time": 0, /* total time the page was ACTIVE */
                    "payment": false,
                    "downloads":0,
                    "seen":100,   // percentage of page seen/amount scrolled
                    "outgoing":0, 
                    "incoming":0,   
                    "visits":0    
             };
    }

    function updateTime(url,time)
    {
      var domain = getDomain(url);
      domains[domain].pages[url].time+=time;
      
    }

    /* end a search session and output the data */
    function finish()
    {
      search = false;
      //TODO: turn off those listeners
      var notification = webkitNotifications.createNotification(
      'icon.png', 'Search over', "Your search for "+query+" has ended.");
      notification.show();
      setTimeout(function(){
        notification.cancel();
      }, '3000');

      /* send JSON objects to PHP */
      var complete = {"query":query};
      complete['session'] = domains;
      var data = JSON.stringify(complete);
      //alert(data);
      var url = "http://localhost/Collab/getJSON.php";
      //var url = "http://jbordoe.webfactional.com/Photo/getThumbs.php";
      var request = null;
      request = new XMLHttpRequest();
      request.open("POST",url,true);
      
      request.onreadystatechange = function(){
        if (request.readyState == 4) {  
        //alert(request.responseText);        
          var not = webkitNotifications.createNotification(
          'icon.png', 'Data Sent', ''+request.responseText);
          not.show();
          setTimeout(function(){
            not.cancel();
          }, '2000');
        } else {
            //..
        }

      }  
      request.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
      request.send("data="+data);
      //alert(data);
      //request.send("data=" + encodeURIComponent(data).replace(/%20/g, '+'));    

    }

    //TODO: method for cancelling the search session 
    


    function inject(query)
    {
      //TODO: check that active page is google search
      //if so, extract query and inject any collab results
      var tmp = "http:/localhost/Collab/q-"+query+".txt"; 
      request = new XMLHttpRequest();
      request.open("GET",tmp,true);      
      request.onreadystatechange = function(){
        if (request.readyState == 4) {  
          page = request.responseText; 
          //TODO - contact google for better headers/summary??
          chrome.tabs.executeScript(null,
      {code:"document.getElementById('topstuff').innerHTML = \
      '<div style=\"-webkit-border-radius:8px; background-color:#ADB0FF; margin:7px; padding:8px; \">\
      <h2>Your Collaborative Search Results for:"+query+"</h2>\
      <br><b><a href=\""+page+"\">"+page+"</a></b></div>'"});
           
          
        }
      }
      request.send();      
    }

  </script>
</html>